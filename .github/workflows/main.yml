name: ğŸš€ Auto-Coin CI/CD with Rollback

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    name: ğŸ§ª Test & Validate
    runs-on: ubuntu-latest
    outputs:
      test-status: ${{ steps.test-results.outputs.status }}
      coverage: ${{ steps.test-results.outputs.coverage }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flake8 bandit

          # Install requirements with error handling
          if ! pip install -r requirements.txt; then
            echo "âš ï¸ Some dependencies failed, installing core only"
            pip install pyyaml requests pyupbit psutil pandas numpy || true
          fi

      - name: ğŸ”’ Security Check
        run: |
          bandit -r . -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            HIGH_ISSUES=$(python -c "
            import json
            try:
                with open('bandit-report.json') as f:
                    report = json.load(f)
                    high = [i for i in report.get('results', []) if i.get('issue_severity') == 'HIGH']
                    print(len(high))
            except: print(0)
            ")
            echo "ğŸ” Security scan: $HIGH_ISSUES high-severity issues found"
          fi
        continue-on-error: true

      - name: ğŸ“Š Config Validation
        run: |
          # Use template config for CI/CD if config.yaml doesn't exist
          if [ ! -f "config.yaml" ] && [ -f "config.template.yaml" ]; then
            echo "ğŸ“‹ Using template config for CI/CD testing..."
            cp config.template.yaml config.yaml
          fi

          python -c "
          import yaml
          import sys

          try:
              with open('config.yaml', 'r', encoding='utf-8') as f:
                  config = yaml.safe_load(f)
                  
              # Check if config is valid
              if config is None:
                  print('âŒ Config file is empty or invalid')
                  sys.exit(1)
              
              if not isinstance(config, dict):
                  print('âŒ Config is not a valid dictionary')
                  sys.exit(1)
              
              # Check required sections
              required_sections = ['upbit', 'trading']
              missing = []
              
              for section in required_sections:
                  if section not in config or config[section] is None:
                      missing.append(section)
              
              if missing:
                  print(f'âŒ Missing required sections: {missing}')
                  sys.exit(1)
              
              print('âœ… Configuration validation passed')
              print(f'ğŸ“‹ Found sections: {list(config.keys())}')
              
          except Exception as e:
              print(f'âŒ Config validation failed: {e}')
              sys.exit(1)
          "

      - name: ğŸ§ª Run Tests with Coverage
        id: test-results
        run: |
          if python -m pytest tests/ -v --tb=short --cov=modules --cov=scripts --cov-report=term-missing; then
            echo "âœ… All tests passed!"
            echo "status=pass" >> $GITHUB_OUTPUT
            COVERAGE=$(python -m pytest tests/ --cov=modules --cov=scripts --cov-report=term 2>/dev/null | grep TOTAL | awk '{print $4}' || echo "0%")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed!"
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "coverage=0%" >> $GITHUB_OUTPUT
            
            # Generate failure report
            python -m pytest tests/ --tb=long --maxfail=3 > test-failures.txt 2>&1 || true
            echo "ğŸ“„ Failure details saved to artifact"
            exit 1
          fi

      - name: ğŸ“‚ Import Check
        run: |
          python -c "
          import modules
          from modules.config_manager import ConfigManager
          from modules.trading_engine import TradingEngine
          print('âœ… Core imports successful')
          "

      - name: ğŸ“„ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            test-failures.txt
            bandit-report.json
          retention-days: 7

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    # Only run deployment if tests pass and it's a master branch push
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' && needs.test.outputs.test-status == 'pass'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Verify Deployment Prerequisites
        id: check-deployment
        run: |
          echo "ğŸ” Checking deployment prerequisites..."

          # Check if this is a deployment environment (secrets available)
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ] && [ -n "${{ secrets.HOST }}" ] && [ -n "${{ secrets.USERNAME }}" ]; then
            echo "âœ… All deployment secrets are available"
            echo "deploy-ready=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Deployment secrets not found - skipping deployment"
            echo "â„¹ï¸ This is normal for forks or when secrets aren't configured"
            echo "deploy-ready=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ Setup SSH
        if: steps.check-deployment.outputs.deploy-ready == 'true'
        run: |
          mkdir -p ~/.ssh

          # Setup SSH key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add host to known_hosts
          echo "ğŸ”— Adding ${{ secrets.HOST }} to known hosts..."
          ssh-keyscan -H "${{ secrets.HOST }}" >> ~/.ssh/known_hosts

          echo "âœ… SSH setup completed"

      - name: ğŸš€ Deploy with Backup
        id: deploy
        if: steps.check-deployment.outputs.deploy-ready == 'true'
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            echo "ğŸ”„ Starting deployment..."
            
            cd /home/ubuntu/auto-trader-v2 2>/dev/null || cd /home/ubuntu/auto-coin || cd /home/ubuntu/auto-bitcoin-trading
            
            # Create backup
            BACKUP_DIR="/home/ubuntu/backups/auto-coin-$(date +%Y%m%d-%H%M%S)"
            mkdir -p $BACKUP_DIR
            cp -r . $BACKUP_DIR/ || echo "âš ï¸ Backup warning"
            echo "ğŸ’¾ Backup: $BACKUP_DIR"
            
            # Stop services
            pm2 stop auto-trader auto-optimizer || echo "Services not running"
            
            # Update code
            git fetch origin && git reset --hard origin/master
            
            # Install deps
            pip install -r requirements.txt || echo "âš ï¸ Dependency warning"
            
            # Validate
            python -c "import yaml; yaml.safe_load(open('config.yaml')); import modules; print('âœ… Validation OK')"
            
            # Restart
            pm2 restart auto-trader auto-optimizer || pm2 start ecosystem.config.js
            
            # Verify
            sleep 3
            if pm2 status | grep -q online; then
              echo "âœ… Deployment successful!"
            else
              echo "âŒ Service start failed"
              exit 1
            fi
          EOF

      - name: ğŸ‰ Success Notification
        if: success() && steps.check-deployment.outputs.deploy-ready == 'true'
        run: |
          echo "ğŸ‰ âœ… DEPLOYMENT SUCCESSFUL!"
          echo "ğŸ“Š Coverage: ${{ needs.test.outputs.coverage }}"
          echo "ğŸš€ Services running on production"

      - name: â„¹ï¸ Deployment Skipped
        if: steps.check-deployment.outputs.deploy-ready == 'false'
        run: |
          echo "â„¹ï¸ Deployment was skipped (secrets not configured)"
          echo "âœ… Tests passed successfully"
          echo "ğŸ“‹ To enable deployment, configure these GitHub Secrets:"
          echo "   - SSH_PRIVATE_KEY: SSH private key for server access"
          echo "   - HOST: Server hostname or IP address"  
          echo "   - USERNAME: SSH username for server"

  rollback:
    name: ğŸ”„ Emergency Rollback
    runs-on: ubuntu-latest
    needs: [test, deploy]
    # Only rollback if deploy failed and secrets are available
    if: always() && needs.deploy.result == 'failure' && needs.test.outputs.test-status == 'pass'

    steps:
      - name: ğŸ”§ Setup SSH for Rollback
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: âš ï¸ Perform Rollback
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            echo "ğŸš¨ EMERGENCY ROLLBACK INITIATED"
            
            cd /home/ubuntu/auto-trader-v2 2>/dev/null || cd /home/ubuntu/auto-coin || cd /home/ubuntu/auto-bitcoin-trading
            
            # Find latest backup
            LATEST_BACKUP=$(ls -t /home/ubuntu/backups/auto-coin-* 2>/dev/null | head -1 || echo "")
            
            if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
              echo "ğŸ“¦ Restoring from: $(basename $LATEST_BACKUP)"
              
              pm2 stop auto-trader auto-optimizer || true
              cp -r $LATEST_BACKUP/* . || true
              pm2 restart auto-trader auto-optimizer || pm2 start ecosystem.config.js
              
              sleep 2
              pm2 status
              echo "âœ… Rollback completed"
            else
              echo "âŒ No backup found!"
            fi
          EOF

      - name: ğŸš¨ Rollback Alert
        run: |
          echo "ğŸš¨ âŒ DEPLOYMENT FAILED - ROLLBACK EXECUTED"
          echo "ğŸ“‹ Previous version restored"
          echo "ğŸ› ï¸ Check logs and fix issues"

  summary:
    name: ğŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [test, deploy, rollback]
    if: always()

    steps:
      - name: ğŸ“Š Final Report
        run: |
          echo "=== ğŸš€ AUTO-COIN CI/CD SUMMARY ==="
          echo ""
          echo "ğŸ§ª Tests: ${{ needs.test.result }}"
          echo "ğŸ“Š Coverage: ${{ needs.test.outputs.coverage || 'N/A' }}"
          echo "ğŸš€ Deploy: ${{ needs.deploy.result || 'Skipped' }}"
          echo "ğŸ”„ Rollback: ${{ needs.rollback.result || 'Not needed' }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""

          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "âŒ PIPELINE STATUS: TEST FAILED"
            echo "ğŸ” Action needed: Fix failing tests"
            echo "ğŸ“‹ Check test-reports artifact for details"
          elif [ "${{ needs.deploy.result }}" = "failure" ]; then
            echo "âš ï¸ PIPELINE STATUS: DEPLOYMENT FAILED"
            echo "ğŸ”„ Action taken: Automatic rollback executed"
            echo "ğŸ› ï¸ Action needed: Fix deployment issues"
          elif [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… PIPELINE STATUS: FULLY SUCCESSFUL"
            echo "ğŸ‰ New version deployed and running"
          elif [ "${{ needs.deploy.result }}" = "skipped" ]; then
            echo "â„¹ï¸ PIPELINE STATUS: TESTS PASSED, DEPLOYMENT SKIPPED"
            echo "âœ… All tests passed successfully"
            echo "ğŸ”§ Deployment skipped (secrets not configured)"
            echo "ğŸ“‹ Configure GitHub Secrets to enable deployment"
          else
            echo "â„¹ï¸ PIPELINE STATUS: PR/NON-MASTER BRANCH"
            echo "âœ… Tests passed, ready for merge"
          fi
