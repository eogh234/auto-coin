name: ğŸš€ Auto-Coin CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.8"
  PM2_APP_NAME: "auto-trader"

jobs:
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ë‹¨ê³„
  test:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest flake8 black

      - name: ğŸ¨ Code Style Check
        run: |
          flake8 modules/ main.py --max-line-length=100 --extend-ignore=E203,W503

      - name: ğŸ” Security Check
        run: |
          pip install safety
          safety check

      - name: ğŸ§ª Run Module Tests
        run: |
          python -m pytest tests/ -v || echo "í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ"

      - name: ğŸ“Š Backtest Validation
        run: |
          python main.py --backtest --days 7 --ticker KRW-BTC

      - name: ğŸ“ˆ Performance Analysis Test
        run: |
          python main.py --analyze --days 1

  # ğŸš€ ë°°í¬ ë‹¨ê³„ (master ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œì—ë§Œ)
  deploy:
    name: ğŸš€ Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: ğŸ“¡ Deploy to Server
        run: |
          echo "ğŸŒ Deploying to production server..."

          # ì„œë²„ ì—°ê²° ë° ë°°í¬
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            
            echo "ğŸ›‘ Stopping current application..."
            pm2 stop ${{ env.PM2_APP_NAME }} || true
            
            echo "ğŸ“ Backing up current version..."
            cd /home/ubuntu
            [ -d auto-trader-v2-backup ] && rm -rf auto-trader-v2-backup
            [ -d auto-trader-v2 ] && mv auto-trader-v2 auto-trader-v2-backup
            
            echo "ğŸ“¥ Downloading latest code..."
            wget -q -O latest-release.tar.gz https://github.com/eogh234/auto-coin/archive/refs/heads/master.tar.gz
            tar -xzf latest-release.tar.gz
            mv auto-coin-master auto-trader-v2
            rm latest-release.tar.gz
            
            echo "ğŸ”§ Setting up environment..."
            cd auto-trader-v2
            
            # ê¸°ì¡´ ì„¤ì • íŒŒì¼ ë³µì‚¬
            if [ -f "/home/ubuntu/auto-trader-v2-backup/config.yaml" ]; then
              cp /home/ubuntu/auto-trader-v2-backup/config.yaml ./
            fi
            
            # ê¸°ì¡´ ê±°ë˜ ë°ì´í„° ë³µì‚¬
            if [ -f "/home/ubuntu/auto-trader-v2-backup/trading_data.json" ]; then
              cp /home/ubuntu/auto-trader-v2-backup/trading_data.json ./
            fi
            
            # ê¸°ì¡´ í•™ìŠµ ë°ì´í„° ë³µì‚¬
            if [ -f "/home/ubuntu/auto-trader-v2-backup/trade_history.db" ]; then
              cp /home/ubuntu/auto-trader-v2-backup/trade_history.db ./
            fi
            
            echo "ğŸ“¦ Installing dependencies..."
            pip3 install -r requirements.txt --user
            
            echo "ğŸš€ Starting application..."
            pm2 start main.py --name ${{ env.PM2_APP_NAME }} --interpreter python3
            pm2 save
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: ğŸ” Health Check
        run: |
          echo "ğŸ¥ Performing health check..."
          sleep 30

          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            if pm2 describe ${{ env.PM2_APP_NAME }} | grep -q "online"; then
              echo "âœ… Application is running successfully"
              pm2 logs ${{ env.PM2_APP_NAME }} --lines 10
            else
              echo "âŒ Application failed to start"
              pm2 logs ${{ env.PM2_APP_NAME }} --lines 20
              exit 1
            fi
          EOF

      - name: ğŸ“¢ Deployment Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸš€ Auto-Coin Deployment ${{ job.status }}
            ğŸ“¦ Commit: ${{ github.sha }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸŒ Production: https://your-domain.com
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ğŸ·ï¸ ë¦´ë¦¬ì¦ˆ íƒœê¹… (ì„ íƒì‚¬í•­)
  tag-release:
    name: ğŸ·ï¸ Auto Tagging
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Generate Tag
        id: tag
        run: |
          # ë§ˆì§€ë§‰ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          # ë²„ì „ ì¦ê°€ (patch ë²„ì „)
          NEW_TAG=$(echo $LAST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "New tag: $NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create Release
        if: steps.tag.outputs.tag != ''
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: Auto-Coin ${{ steps.tag.outputs.tag }}
          body: |
            ğŸš€ **Auto-Coin Release ${{ steps.tag.outputs.tag }}**

            ### ğŸ”„ Changes in this release:
            - Automated deployment via GitHub Actions
            - Enhanced error handling and logging
            - Performance optimizations

            ### ğŸ“Š Deployment Info:
            - **Commit**: ${{ github.sha }}
            - **Author**: ${{ github.actor }}
            - **Date**: ${{ github.event.head_commit.timestamp }}

            ### ğŸ§ª Validation:
            - âœ… All tests passed
            - âœ… Code quality checks passed
            - âœ… Backtest validation completed
            - âœ… Production health check passed

            ---
            *This release was automatically created by GitHub Actions*
          draft: false
          prerelease: false
