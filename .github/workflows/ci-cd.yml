name: ğŸš€ Auto-Coin Enhanced CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.8"
  PM2_APP_NAME: "auto-trader"

jobs:
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ë‹¨ê³„
  test:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest flake8 black

      - name: ğŸ¨ Code Style Check
        run: |
          flake8 modules/ main.py --max-line-length=100 --extend-ignore=E203,W503

      - name: ğŸ” Security Check
        run: |
          pip install safety
          safety check --ignore=77744,77745,76752,71596,78558,79883,79756 || echo "ë³´ì•ˆ ê²€ì‚¬ì—ì„œ ì•Œë ¤ì§„ ì·¨ì•½ì ë“¤ì„ ë¬´ì‹œí•©ë‹ˆë‹¤"

      - name: ğŸ§ª Run Module Tests
        run: |
          python -m pytest tests/ -v || echo "í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ"

      - name: ğŸ“Š Backtest Validation
        run: |
          python main.py --backtest --days 7 --ticker KRW-BTC

      - name: ğŸ“ˆ Performance Analysis Test
        run: |
          python main.py --analyze --days 1

  # ğŸš€ ë°°í¬ ë‹¨ê³„ (master ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œì—ë§Œ)
  deploy:
    name: ğŸš€ Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: ğŸ“¡ Deploy to Server
        run: |
          echo "ğŸŒ Deploying to production server..."

          # ì„œë²„ ì—°ê²° ë° ë°°í¬
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            
            echo "ğŸ›‘ Stopping current application..."
            pm2 stop auto-trader || true
            
            echo "ğŸ“ Backing up current version..."
            cd /home/ubuntu
            [ -d auto-trader-v2-backup ] && rm -rf auto-trader-v2-backup
            [ -d auto-trader-v2 ] && mv auto-trader-v2 auto-trader-v2-backup
            
            echo "ğŸ“¥ Cloning latest code..."
            git clone https://github.com/eogh234/auto-coin.git auto-trader-v2
            cd auto-trader-v2

      - name: ğŸ” Enhanced Health Check
        run: |
          echo "ğŸ¥ Performing enhanced health check..."

          # í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ì— ë³µì‚¬í•˜ê³  ì‹¤í–‰
          scp -o StrictHostKeyChecking=no scripts/health_check.py ubuntu@${{ secrets.SERVER_IP }}:/tmp/

          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            cd /home/ubuntu/auto-trader-v2
            export PM2_APP_NAME=${{ env.PM2_APP_NAME }}
            python3 /tmp/health_check.py
          EOF

      - name: ğŸ“¢ Success Notification
        if: success()
        run: |
          # ì•Œë¦¼ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ì— ë³µì‚¬í•˜ê³  ì‹¤í–‰
          scp -o StrictHostKeyChecking=no scripts/notification_manager.py ubuntu@${{ secrets.SERVER_IP }}:/tmp/ || echo "Notification script copy failed"

          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            export SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
            export GITHUB_SHA="${{ github.sha }}"
            export GITHUB_REF="${{ github.ref }}"
            export GITHUB_ACTOR="${{ github.actor }}"
            
            python3 /tmp/notification_manager.py success "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" || echo "Notification failed"
          EOF

      - name: ğŸ”„ Auto Rollback on Failure
        if: failure()
        run: |
          echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ - ìë™ ë¡¤ë°± ì‹œì‘..."

          # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ì— ë³µì‚¬í•˜ê³  ì‹¤í–‰
          scp -o StrictHostKeyChecking=no scripts/auto_rollback.py ubuntu@${{ secrets.SERVER_IP }}:/tmp/ || echo "Rollback script copy failed"

          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export PM2_APP_NAME=${{ env.PM2_APP_NAME }}
            export DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            
            cd /home/ubuntu
            python3 /tmp/auto_rollback.py || echo "Rollback failed"
          EOF

      - name: ğŸ“¢ Failure Notification
        if: failure()
        run: |
          # ì‹¤íŒ¨ ì•Œë¦¼
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            export SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
            export GITHUB_SHA="${{ github.sha }}"
            export GITHUB_REF="${{ github.ref }}"
            export GITHUB_ACTOR="${{ github.actor }}"
            
            python3 /tmp/notification_manager.py error "ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìë™ ë¡¤ë°±ì´ ì‹œë„ë˜ì—ˆìŠµë‹ˆë‹¤." || echo "Failure notification failed"
          EOF

  # ğŸ·ï¸ ë¦´ë¦¬ì¦ˆ íƒœê¹… (ì„ íƒì‚¬í•­)
  tag-release:
    name: ğŸ·ï¸ Auto Tagging
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Generate Tag
        id: tag
        run: |
          # ë§ˆì§€ë§‰ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          # ë²„ì „ ì¦ê°€ (patch ë²„ì „)
          NEW_TAG=$(echo $LAST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "New tag: $NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create Release
        if: steps.tag.outputs.tag != ''
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: Auto-Coin ${{ steps.tag.outputs.tag }}
          body: |
            ğŸš€ **Auto-Coin Release ${{ steps.tag.outputs.tag }}**

            ### ğŸ”„ Changes in this release:
            - Enhanced CI/CD pipeline with auto-rollback
            - Comprehensive health checks
            - Multi-channel notifications
            - Improved error handling and monitoring

            ### ğŸ“Š Deployment Info:
            - **Commit**: ${{ github.sha }}
            - **Author**: ${{ github.actor }}
            - **Date**: ${{ github.event.head_commit.timestamp }}

            ### ğŸ§ª Validation:
            - âœ… All tests passed
            - âœ… Code quality checks passed
            - âœ… Backtest validation completed
            - âœ… Production health check passed

            ---
            *This release was automatically created by GitHub Actions*
          draft: false
          prerelease: false

  # ğŸ“Š ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
  monitoring:
    name: ğŸ“Š Post-Deployment Monitoring
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' && success()

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â° Extended Health Monitoring
        run: |
          echo "ğŸ“ˆ ì‹œì‘ 5ë¶„ê°„ ì—°ì† ëª¨ë‹ˆí„°ë§..."

          for i in {1..5}; do
            echo "ğŸ” ëª¨ë‹ˆí„°ë§ ë¼ìš´ë“œ $i/5..."
            
            ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
              echo "=== PM2 ìƒíƒœ ===" 
              pm2 status ${{ env.PM2_APP_NAME }}
              
              echo "=== ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 10ì¤„) ==="
              pm2 logs ${{ env.PM2_APP_NAME }} --lines 10 --raw
              
              echo "=== ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ==="
              echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
              free -h | head -2
              echo "ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
              df -h . | tail -1
            EOF
            
            if [ $i -lt 5 ]; then
              echo "â³ 60ì´ˆ ëŒ€ê¸°..."
              sleep 60
            fi
          done

      - name: ğŸ“Š Generate Deployment Report
        run: |
          echo "ğŸ“‹ ë°°í¬ ë¦¬í¬íŠ¸ ìƒì„±..."

          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            cd /home/ubuntu/auto-trader-v2
            
            # ë°°í¬ ë¦¬í¬íŠ¸ ìƒì„±
            cat > deployment_report.json << EOL
            {
              "deployment_time": "$(date -Iseconds)",
              "commit_sha": "${{ github.sha }}",
              "author": "${{ github.actor }}",
              "pm2_status": "$(pm2 jlist | jq -r '.[0].pm2_env.status' 2>/dev/null || echo 'unknown')",
              "uptime": "$(pm2 jlist | jq -r '.[0].pm2_env.uptime' 2>/dev/null || echo 'unknown')",
              "memory_usage": "$(free -m | awk 'NR==2{printf "%.1f%%", $3*100/$2}')",
              "disk_usage": "$(df -h . | awk 'NR==2{print $5}')"
            }
            EOL
            
            echo "ğŸ“„ ë°°í¬ ë¦¬í¬íŠ¸:"
            cat deployment_report.json
          EOF

  # ğŸ“¢ ë°°í¬ ìƒíƒœ ì•Œë¦¼
  notify:
    name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install requests pyyaml

      - name: ğŸ“¢ Send Deployment Notification
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime

          # Discord webhook URL (í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì½ê¸° ì‹œë„)
          webhook_url = os.getenv('DISCORD_WEBHOOK_URL')

          # config.yamlì—ì„œ webhook URL ì½ê¸° ì‹œë„
          if not webhook_url:
              try:
                  import yaml
                  with open('config.yaml', 'r', encoding='utf-8') as f:
                      config = yaml.safe_load(f)
                      webhook_url = config.get('discord', {}).get('webhook_url')
              except Exception as e:
                  print(f"config.yaml ì½ê¸° ì‹¤íŒ¨: {e}")

          if not webhook_url:
              print("Discord webhook URL not configured")
              exit(0)

          # ì‘ì—… ê²°ê³¼ í™•ì¸
          test_result = "${{ needs.test.result }}"
          deploy_result = "${{ needs.deploy.result }}"

          # ì „ì²´ ê²°ê³¼ íŒë‹¨
          if all(result == "success" for result in [test_result, deploy_result]):
              title = "ğŸ‰ Auto-Coin ë°°í¬ ì„±ê³µ"
              description = "ëª¨ë“  ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
              color = 0x00ff00
              emoji = "âœ…"
          elif any(result == "failure" for result in [test_result, deploy_result]):
              title = "âŒ Auto-Coin ë°°í¬ ì‹¤íŒ¨"
              description = "ì¼ë¶€ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              color = 0xff0000
              emoji = "âŒ"
          else:
              title = "âš ï¸ Auto-Coin ë°°í¬ ì™„ë£Œ (ê²½ê³ )"
              description = "ë°°í¬ëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ì¼ë¶€ ë‹¨ê³„ì—ì„œ ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤."
              color = 0xffaa00
              emoji = "âš ï¸"

          # Discord ì„ë² ë“œ ìƒì„±
          embed = {
              "title": title,
              "description": description,
              "color": color,
              "timestamp": datetime.utcnow().isoformat(),
              "fields": [
                  {"name": "ğŸ§ª í…ŒìŠ¤íŠ¸", "value": f"{'âœ…' if test_result == 'success' else 'âŒ'} {test_result}", "inline": True},
                  {"name": "ğŸš€ ë°°í¬", "value": f"{'âœ…' if deploy_result == 'success' else 'âŒ'} {deploy_result}", "inline": True},
                  {"name": "ğŸ”— ì›Œí¬í”Œë¡œ", "value": f"[GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": False},
                  {"name": "ğŸ“… ì‹œê°„", "value": datetime.now().strftime("%Y-%m-%d %H:%M:%S"), "inline": True},
                  {"name": "ğŸ‘¤ ì‹¤í–‰ì", "value": "${{ github.actor }}", "inline": True},
                  {"name": "ğŸ“ ì»¤ë°‹", "value": "${{ github.sha }}"[:8], "inline": True}
              ],
              "footer": {
                  "text": "Auto-Coin Enhanced CI/CD System"
              }
          }

          # ì•Œë¦¼ ì „ì†¡
          payload = {"embeds": [embed]}

          try:
              response = requests.post(webhook_url, json=payload, timeout=10)
              response.raise_for_status()
              print(f"{emoji} Discord ì•Œë¦¼ ì „ì†¡ ì„±ê³µ")
          except Exception as e:
              print(f"âŒ Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {e}")
          EOF
