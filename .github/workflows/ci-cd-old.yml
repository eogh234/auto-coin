name: ğŸš€ Auto-Coin CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.8"
  PM2_APP_NAME: "auto-trader"

jobs:
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ë‹¨ê³„
  test:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest flake8 black

      - name: ğŸ¨ Code Style Check
        run: |
          flake8 modules/ main.py --max-line-length=100 --extend-ignore=E203,W503

      - name: ğŸ” Security Check
        run: |
          pip install safety
          safety check --ignore=77744,77745,76752,71596,78558,79883,79756 || echo "ë³´ì•ˆ ê²€ì‚¬ì—ì„œ ì•Œë ¤ì§„ ì·¨ì•½ì ë“¤ì„ ë¬´ì‹œí•©ë‹ˆë‹¤"

      - name: ğŸ§ª Run Module Tests
        run: |
          python -m pytest tests/ -v || echo "í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ"

      - name: ğŸ“Š Backtest Validation
        run: |
          python main.py --backtest --days 7 --ticker KRW-BTC

      - name: ğŸ“ˆ Performance Analysis Test
        run: |
          python main.py --analyze --days 1

  # ğŸš€ ë°°í¬ ë‹¨ê³„ (master ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œì—ë§Œ)
  deploy:
    name: ğŸš€ Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: ğŸ“¡ Deploy to Server
        run: |
          echo "ğŸŒ Deploying to production server..."

          # ì„œë²„ ì—°ê²° ë° ë°°í¬
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            
            echo "ï¿½ ë°°í¬ ì‹œì‘ ì•Œë¦¼..."
            python3 -c "
import requests, json, os
webhook = os.getenv('DISCORD_WEBHOOK_URL', '${{ secrets.DISCORD_WEBHOOK_URL }}')
if webhook:
    requests.post(webhook, json={'content': 'ğŸš€ Auto-Coin ë°°í¬ ì‹œì‘!'})
" || true
            
            echo "ï¿½ğŸ›‘ Stopping current application..."
            pm2 stop ${{ env.PM2_APP_NAME }} || true
            
            echo "ğŸ“ Backing up current version..."
            cd /home/ubuntu
            [ -d auto-trader-v2-backup ] && rm -rf auto-trader-v2-backup
            [ -d auto-trader-v2 ] && mv auto-trader-v2 auto-trader-v2-backup
            
            echo "ğŸ“¥ Downloading latest code..."
            wget -q -O latest-release.tar.gz https://github.com/eogh234/auto-coin/archive/refs/heads/master.tar.gz
            tar -xzf latest-release.tar.gz
            mv auto-coin-master auto-trader-v2
            rm latest-release.tar.gz
            
            echo "ğŸ”§ Setting up environment..."
            cd auto-trader-v2
            
            # ê¸°ì¡´ ì„¤ì • íŒŒì¼ ë³µì‚¬
            if [ -f "/home/ubuntu/auto-trader-v2-backup/config.yaml" ]; then
              cp /home/ubuntu/auto-trader-v2-backup/config.yaml ./
            fi
            
            # ê¸°ì¡´ ê±°ë˜ ë°ì´í„° ë³µì‚¬
            if [ -f "/home/ubuntu/auto-trader-v2-backup/trading_data.json" ]; then
              cp /home/ubuntu/auto-trader-v2-backup/trading_data.json ./
            fi
            
            # ê¸°ì¡´ í•™ìŠµ ë°ì´í„° ë³µì‚¬
            if [ -f "/home/ubuntu/auto-trader-v2-backup/trade_history.db" ]; then
              cp /home/ubuntu/auto-trader-v2-backup/trade_history.db ./
            fi
            
            echo "ğŸ“¦ Installing dependencies..."
            pip3 install -r requirements.txt --user
            
            echo "ğŸš€ Starting application..."
            pm2 start main.py --name ${{ env.PM2_APP_NAME }} --interpreter python3
            pm2 save
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: ğŸ” Enhanced Health Check
        run: |
          echo "ğŸ¥ Performing enhanced health check..."
          
          # í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ì— ë³µì‚¬í•˜ê³  ì‹¤í–‰
          scp -o StrictHostKeyChecking=no scripts/health_check.py ubuntu@${{ secrets.SERVER_IP }}:/tmp/
          
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            cd /home/ubuntu/auto-trader-v2
            export PM2_APP_NAME=${{ env.PM2_APP_NAME }}
            python3 /tmp/health_check.py
          EOF

      - name: ğŸ“¢ Success Notification
        if: success()
        run: |
          # ì•Œë¦¼ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ì— ë³µì‚¬í•˜ê³  ì‹¤í–‰
          scp -o StrictHostKeyChecking=no scripts/notification_manager.py ubuntu@${{ secrets.SERVER_IP }}:/tmp/
          
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            export SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
            export GITHUB_SHA="${{ github.sha }}"
            export GITHUB_REF="${{ github.ref }}"
            export GITHUB_ACTOR="${{ github.actor }}"
            
            python3 /tmp/notification_manager.py success "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          EOF

      - name: ğŸ”„ Auto Rollback on Failure
        if: failure()
        run: |
          echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ - ìë™ ë¡¤ë°± ì‹œì‘..."
          
          # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ì— ë³µì‚¬í•˜ê³  ì‹¤í–‰
          scp -o StrictHostKeyChecking=no scripts/auto_rollback.py ubuntu@${{ secrets.SERVER_IP }}:/tmp/
          
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export PM2_APP_NAME=${{ env.PM2_APP_NAME }}
            export DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            
            cd /home/ubuntu
            python3 /tmp/auto_rollback.py
          EOF

      - name: ğŸ“¢ Failure Notification
        if: failure()
        run: |
          # ì‹¤íŒ¨ ì•Œë¦¼
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            export SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
            export GITHUB_SHA="${{ github.sha }}"
            export GITHUB_REF="${{ github.ref }}"
            export GITHUB_ACTOR="${{ github.actor }}"
            
            python3 /tmp/notification_manager.py error "ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìë™ ë¡¤ë°±ì´ ì‹œë„ë˜ì—ˆìŠµë‹ˆë‹¤."
          EOF

      # - name: ğŸ“¢ Deployment Notification
      #   if: always()
      #   continue-on-error: true
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: |
      #       ğŸš€ Auto-Coin Deployment ${{ job.status }}
      #       ğŸ“¦ Commit: ${{ github.sha }}
      #       ğŸ‘¤ Author: ${{ github.actor }}
      #       ğŸŒ Production: https://your-domain.com
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ğŸ·ï¸ ë¦´ë¦¬ì¦ˆ íƒœê¹… (ì„ íƒì‚¬í•­)
  tag-release:
    name: ğŸ·ï¸ Auto Tagging
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Generate Tag
        id: tag
        run: |
          # ë§ˆì§€ë§‰ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          # ë²„ì „ ì¦ê°€ (patch ë²„ì „)
          NEW_TAG=$(echo $LAST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "New tag: $NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create Release
        if: steps.tag.outputs.tag != ''
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: Auto-Coin ${{ steps.tag.outputs.tag }}
          body: |
            ğŸš€ **Auto-Coin Release ${{ steps.tag.outputs.tag }}**

            ### ğŸ”„ Changes in this release:
            - Automated deployment via GitHub Actions
            - Enhanced error handling and logging
            - Performance optimizations

            ### ğŸ“Š Deployment Info:
            - **Commit**: ${{ github.sha }}
            - **Author**: ${{ github.actor }}
            - **Date**: ${{ github.event.head_commit.timestamp }}

            ### ğŸ§ª Validation:
            - âœ… All tests passed
            - âœ… Code quality checks passed
            - âœ… Backtest validation completed
            - âœ… Production health check passed

            ---
            *This release was automatically created by GitHub Actions*
          draft: false
          prerelease: false
