name: ğŸš€ Auto-Coin Testing & Deployment

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    name: ğŸ§ª Test & Validate
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flake8
          pip install -r requirements.txt

      - name: ğŸ” Lint Check
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=__pycache__
        continue-on-error: true

      - name: ğŸ“Š Configuration Validation
        run: |
          python -c "
          import yaml
          with open('config.yaml', 'r', encoding='utf-8') as f:
              config = yaml.safe_load(f)
              print('âœ… Configuration is valid YAML')
              assert 'upbit' in config, 'Missing upbit section'
              assert 'trading' in config, 'Missing trading section'
              print('âœ… Required config sections found')
          "

      - name: ğŸ§ª Run Tests
        run: |
          python -m pytest tests/ -v --tb=short

      - name: ğŸ“‚ Import Validation
        run: |
          python -c "
          # Test core imports
          import modules
          from modules.config_manager import ConfigManager
          from modules.trading_engine import TradingEngine
          from scripts.auto_optimizer import AutoOptimizationEngine
          print('âœ… All critical modules import successfully')
          "

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to Server
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'ENDSSH'
            set -e
            echo "ğŸ”„ Starting deployment..."
            
            cd /home/ubuntu/auto-coin
            
            # Create backup
            BACKUP_DIR="/home/ubuntu/backups/auto-coin-$(date +%Y%m%d-%H%M%S)"
            mkdir -p $BACKUP_DIR
            cp -r . $BACKUP_DIR/ 2>/dev/null || echo "âš ï¸ Backup warning"
            
            # Stop services
            echo "â¹ï¸ Stopping services..."
            pm2 stop auto-trader auto-optimizer 2>/dev/null || echo "Services not running"
            
            # Update code
            echo "ğŸ“¡ Updating code..."
            git fetch origin
            git reset --hard origin/master
            
            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            pip install -r requirements.txt
            
            # Quick validation
            echo "âœ… Validating..."
            python -c "import yaml; yaml.safe_load(open('config.yaml'))"
            python -c "import modules; print('Modules OK')"
            
            # Restart services
            echo "ğŸ”„ Restarting services..."
            pm2 restart auto-trader auto-optimizer || pm2 start ecosystem.config.js
            
            # Verify
            sleep 3
            pm2 status
            echo "âœ… Deployment completed!"
          ENDSSH

      - name: ğŸ‰ Success Notification
        if: success()
        run: echo "âœ… Deployment successful!"

      - name: âŒ Failure Notification
        if: failure()
        run: echo "âŒ Deployment failed - check logs"
